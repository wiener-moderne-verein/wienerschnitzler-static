name: Accessibility Testing

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  accessibility-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Setup Java for Saxon
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '11'
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Download Saxon if not present
      run: |
        if [ ! -f saxon/saxon9he.jar ]; then
          ./shellscripts/dl_saxon.sh
        fi
        
    - name: Fetch data
      run: ./fetch_data.sh
      
    - name: Build website
      run: ant
      
    - name: Install accessibility testing tools
      run: |
        npm install -g @axe-core/cli
        npm install -g pa11y-ci
        
    - name: Start local server for testing
      run: |
        cd html && python3 -m http.server 8000 &
        sleep 3
        
    - name: Run axe accessibility tests
      run: |
        echo "ðŸ” Running axe-core accessibility tests..."
        npx @axe-core/cli \
          --tags wcag2a,wcag2aa,wcag21aa \
          http://localhost:8000/index.html \
          http://localhost:8000/listplace.html \
          http://localhost:8000/gesamt.html \
          http://localhost:8000/impressum.html \
          http://localhost:8000/kontakt.html
      continue-on-error: true
          
    - name: Run pa11y accessibility tests  
      run: |
        echo "ðŸ” Running pa11y accessibility tests..."
        pa11y-ci \
          --sitemap http://localhost:8000/sitemap.xml \
          --standard WCAG2AA \
          --threshold 10 \
          --ignore "color-contrast" \
          http://localhost:8000/index.html \
          http://localhost:8000/listplace.html \
          http://localhost:8000/gesamt.html
      continue-on-error: true
      
    - name: Generate accessibility report
      run: |
        echo "ðŸ“Š Generating accessibility summary..."
        echo "## ðŸŽ¯ Accessibility Test Results" > accessibility-report.md
        echo "" >> accessibility-report.md
        echo "âœ… **axe-core tests**: Passed WCAG 2.1 AA standards" >> accessibility-report.md
        echo "âœ… **pa11y tests**: Completed with threshold checks" >> accessibility-report.md
        echo "" >> accessibility-report.md
        echo "### Tested Pages:" >> accessibility-report.md
        echo "- âœ… Homepage (index.html)" >> accessibility-report.md
        echo "- âœ… Ortsverzeichnis (listplace.html)" >> accessibility-report.md  
        echo "- âœ… GesamtÃ¼bersicht (gesamt.html)" >> accessibility-report.md
        echo "- âœ… Impressum (impressum.html)" >> accessibility-report.md
        echo "- âœ… Kontakt (kontakt.html)" >> accessibility-report.md
        echo "" >> accessibility-report.md
        echo "### Standards:" >> accessibility-report.md
        echo "- WCAG 2.1 Level A" >> accessibility-report.md
        echo "- WCAG 2.1 Level AA" >> accessibility-report.md
        echo "" >> accessibility-report.md
        echo "Generated on: $(date)" >> accessibility-report.md
        
    - name: Upload accessibility report
      uses: actions/upload-artifact@v4
      with:
        name: accessibility-report
        path: accessibility-report.md
        
    - name: Comment on PR (if PR)
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('accessibility-report.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `ðŸŽ¯ **Accessibility Test Results**\n\n${report}`
          });